---
title: "Executive functions predict psychopathic traits in incarcerated violent offenders"
author: "Carl Delfin"
date: "15 March 2018"
output:
  pdf_document: default
  html_document: default
  word_document: default
---

# Introduction

This RMarkdown document contains the R code used for all analysis in the study **Executive functions predict psychopathic traits in incarcerated violent offenders**.

In this text, `this` refers to a function or variable within R, *this* to an externally sourced script, and [this](https://en.wikipedia.org/wiki/Hyperlink) is a link to some external website.

# Clear environment

Clear any existing data, values and functions from the global environment.

```{r}
rm(list = ls())
```

# Start timer

Not really necessary, but I want to keep track of total running time for the entire analysis pipeline.

```{r}
ptm <- proc.time()
```

# Set-up

Setting up paths, loading packages and reading data.

## Paths and keys

Paths and [API keys](https://developers.google.com/sheets/api/guides/authorizing#APIKey) are stored in an external script for security reasons. Variables written in ALL CAPS are pre-defined paths/keys.

```{r}
source("secret/pathsandkeys.R")
```

## Load packages 

All required packages are stored in a vector.

```{r}
requiredPackages <- c("foreign", "googlesheets", "ggplot2", "caret", "psych", "relaimpo", "sandwich", "cowplot", "magrittr", "lmtest", "car", "broom")
```

The *ipak* script goes through the `requiredPackages` vector and checks if the required packages are installed, installs them if not, then loads them.

```{r message=FALSE, warning=FALSE}
source("scripts/ipak.R")
ipak(requiredPackages)
rm(requiredPackages, ipak)
```

## Data and seed

The data is read from an SPSS file and the seed is set for reproducibility (I always use the year the analysis was conducted, in this case 2018, to avoid "seed hacking"). The `seed` function uses [Mersenne Twister](https://en.wikipedia.org/wiki/Mersenne_Twister) by default.

```{r, message=FALSE, warning=FALSE}
data <- read.spss(DATALOCATION, to.data.frame = TRUE); rm(DATALOCATION)
seed <- 2018
```

# Data preparation

## Select predictors

Define the outcome variable and which predictors to use. The names must, obviously, match variable names in the data frame.

```{r}
# outcome variables
outcomeVariables <- c("facet1", "facet2", "facet3", "facet4")

# EF predictors
predictorList <- c("IEDstages", "IEDtotaler",
                   "SWMtotaler", "SWMstrategy",
                   "SSTSSRT", "SSTMDNRT",
                   "SOCMITT5", "SOCPS")

# rename column
colnames(data)[colnames(data) == "SSTMediancorrectRTonGOtrials"] <- "SSTMDNRT"

# other variables of interest
otherList <- "age"

# subset data to selected variables
data <- data[, c(otherList, outcomeVariables, predictorList)]

# drop missing data
data <- data[complete.cases(data[, c(predictorList, outcomeVariables)]), ]

# convert ms to s
data$SOCMITT5 <- data$SOCMITT5 / 1000
data$SSTSSRT <- data$SSTSSRT / 1000
data$SSTMDNRT <- data$SSTMDNRT / 1000
```

# Data exploration

## Table 1

Table 1 in the manuscript consists of an overview of numerical variables. Results are stored on Google Drive using the `googlesheets` package. See *table_1.R* for additional details.

```{r}
source("scripts/table1.R")
gd_results <- gs_key(KEY)
gd_results <- gd_results %>%
gs_edit_cells(ws = "table1", input = table1)
rm(table1)
```

## Diagostics

Before going further let's do a simple diagnostic check on the linear models. Looking at the residual versus fitted plots, we see some [heteroscedasticity](https://en.wikipedia.org/wiki/Heteroscedasticity). Thus, heteroscedasticity-consistent standard errors will be used throughout. Looking at [Q-Q plots](https://en.wikipedia.org/wiki/Q%E2%80%93Q_plot), some deviations from normality are evident, although not enough to warrant further actions. See *diagnostics.R* for details.

```{r}
source("scripts/diagnostics.R")
```

# Model building

## Model formulas

Model formulas are stored in a list.

```{r}
formulaList <- as.list(NULL)
formulaList <- lapply(outcomeVariables, function(i) {
  paste(i, paste(predictorList, collapse = "+"), sep = "~")
  })
```

## Estimate regression models

This is where the fun stuff happens. We use the `lapply` function to loop through a series of lists:

1. Loop through `formulaList` using `lm` to estimate regression models, and store the results in `modelList`
2. Loop through the newly created `modelList` using:
    + `waldtest`, `coeftest` and `confint.robust` with [heteroscedasticity consistent (HC)](https://en.wikipedia.org/wiki/Heteroscedasticity-consistent_standard_errors)
    + `vif` for extracting [variance inflation factors](https://en.wikipedia.org/wiki/Variance_inflation_factor)
    + `calc.relimp` for relative importance estimation
3. Loop through `formulaList` again using `train` to estimate cross-validated *R*<sup>2</sup>

```{r}
source("scripts/confintrobust.R")

# estimate linear models
modelList <- lapply(formulaList, function(x, data) eval(bquote(lm(.(x), data))), data = data)

# lapply through modelList
modelWald <- lapply(modelList, waldtest, test = "F", vcov = vcovHC)
modelHC   <- lapply(modelList, coeftest, vcov = vcovHC)
modelCI   <- lapply(modelList, confint.robust)
modelVIF  <- lapply(modelList, vif)
modelRI   <- lapply(modelList, calc.relimp, type = "lmg", rela = FALSE)

# cross-validation
modelCV   <- NULL
control = trainControl(method = "repeatedcv", number = 10, repeats = 100)
set.seed(seed)
modelCV <- lapply(formulaList, function(i) {
  train(as.formula(i), data = data, method = "lm", trControl = control)})

rm(formulaList, control)
```

## Model summary

A summary of each regression model is stored in a text file. See *regressionsummary.R* for details.

```{r}
source("scripts/regressionsummary.R")
lapply(regressionsummary, write, "results/results.txt", append = TRUE)
rm(regressionsummary, modelWald, modelCV)
```

## Table 2

Table 2 contains detailed model summaries, such as betas, *p*-values and CIs. See *table2.R* for details. Results are stored using `googlesheets`.

```{r}
source("scripts/table2.R")
gd_results <- gs_key(KEY)
gd_results <- gd_results %>%
gs_edit_cells(ws = "table2", input = table2)
```

## Relative importance estimation

Relative importance estimates are plotted and saved in .tiff format. See *relaimpo.R* for details. Note that model relative importane sum to unadjusted model *R*<sup>2</sup>.

```{r}
source("scripts/relaimpo.R")
ggsave(filename = "figures/riplot.tiff",
       plot = riplot,
       height = 6,
       width = 16,
       dpi = 300)
#rm(riplot)
```

## Variance inflation factors

Collinearity is assessed by looking at variance inflation factors (VIFs). VIFs are presented in text, so we only want a .txt with the output.

```{r}
vifs <- capture.output(cat("The VIFs range from", range(modelVIF)[1], "to", range(modelVIF)[2]))
write(vifs, file = "results/vifs.txt")
remove(modelVIF, vifs)
```

# Session info

A text file with the session info.

```{r}
sessInfo <- capture.output(sessionInfo())
write(sessInfo, file = "sessioninfo.txt")
```

# Stop timer

Stop timer, stores results in a text file.

```{r}
time <- proc.time() - ptm
write(capture.output(paste("analysis took", round(time[3]/60, 0), "minute(s)")), file = "timer.txt")
```
